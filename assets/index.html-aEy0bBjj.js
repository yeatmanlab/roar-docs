import{_ as o,c as d,a as s,b as a,e as n,f as l,d as u,r as t,o as c}from"./app-Bp2p-J6b.js";const p={};function m(v,e){const i=t("RouteLink"),r=t("Mermaid");return c(),d("div",null,[e[34]||(e[34]=s("h1",{id:"querying-assessment-data",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#querying-assessment-data"},[s("span",null,"Querying Assessment Data")])],-1)),s("p",null,[e[1]||(e[1]=a("ROAR's ")),n(i,{to:"/developer/databases/assessment.html"},{default:l(()=>e[0]||(e[0]=[a("assessment data")])),_:1}),e[2]||(e[2]=a(" is exported from Firestore to ")),e[3]||(e[3]=s("a",{href:"https://cloud.google.com/bigquery?hl=en",target:"_blank",rel:"noopener noreferrer"},"BigQuery",-1)),e[4]||(e[4]=a(". This guide will walk you through the process of querying assessment data from BigQuery, including installation, authentication, understanding schemas, and exporting results to your local machine or a Google Cloud bucket."))]),e[35]||(e[35]=s("div",{class:"hint-container tip"},[s("p",{class:"hint-container-title"},"How to use this guide"),s("p",null,"Please read through this entire guide (and work through the examples) before executing your production queries with BigQuery. BigQuery is a very powerful tool but its incorrect use can inflate ROAR's costs so it is important to read through the guide to the end to adopt best practices.")],-1)),e[36]||(e[36]=s("h2",{id:"tables-and-views",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#tables-and-views"},[s("span",null,"Tables and Views")])],-1)),e[37]||(e[37]=s("p",null,"BigQuery organizes data into datasets and tables (or views). Below are the key views available for querying in our lab's BigQuery project. The diagram below represents the relationships between these different views.",-1)),n(r,{id:"mermaid-17",code:"eJytVMlugzAUvOcrnji1hyj3nruoapVWaS5VFCEXHLBKMPKSCiX99xovrAZUKRyQ5TfzPDPPgNk9QQlDxwWoR3LMOJz1uno+tpvn9RMwilgoSQzvL73Sbg8x4YKRSPAwkozhXMCjB8WjlNJsGhNliHM8jUkYlcU05ICOJCPDPr+L2mPIZO7zKfPQ57IJwHeeEk2SnORJWEcxg7NhzKBsHDMoE8gMyEXii0IpRkrLIAy9PxKHyanbjLKE74ImgpWbuVo5Kys7P7VwkoL98GjXxJwOwc02xRyDmiURlYsfkmWQohOGt/Xrp3o9AD2A0KCCkRMSGL5xyW+Dfmcjye9Ki/SXtGp/SfsoWzUbRyIxVykMvOn9Efh/r2XdqzsJs32tuZp/wuWyXNJz6+O5g2CDM5V0DF9l/YGYwBtUm2YF9Yj6yBFadaV6+OZO71QVRFngfcOeYjZ492MwPDsoS2zNoUt3WbdIHa2d0P0e/wDBRpz4"}),e[38]||(e[38]=s("p",null,"The diagram above only lists a subset of the attributes for each entity. For an exhaustive list of attributes for each view, click on the links below to view schema tables:",-1)),s("ul",null,[s("li",null,[n(i,{to:"/developer/bigquery/users.html"},{default:l(()=>e[5]||(e[5]=[s("code",null,"users",-1)])),_:1})]),s("li",null,[n(i,{to:"/developer/bigquery/user_runs.html"},{default:l(()=>e[6]||(e[6]=[s("code",null,"user_runs",-1)])),_:1})]),s("li",null,[n(i,{to:"/developer/bigquery/user_trials.html"},{default:l(()=>e[7]||(e[7]=[s("code",null,"user_trials",-1)])),_:1})]),s("li",null,[n(i,{to:"/developer/bigquery/districts.html"},{default:l(()=>e[8]||(e[8]=[s("code",null,"districts",-1)])),_:1})]),s("li",null,[n(i,{to:"/developer/bigquery/schools.html"},{default:l(()=>e[9]||(e[9]=[s("code",null,"schools",-1)])),_:1})]),s("li",null,[n(i,{to:"/developer/bigquery/classes.html"},{default:l(()=>e[10]||(e[10]=[s("code",null,"classes",-1)])),_:1})]),s("li",null,[n(i,{to:"/developer/bigquery/groups.html"},{default:l(()=>e[11]||(e[11]=[s("code",null,"groups",-1)])),_:1})]),s("li",null,[n(i,{to:"/developer/bigquery/families.html"},{default:l(()=>e[12]||(e[12]=[s("code",null,"families",-1)])),_:1})]),s("li",null,[e[14]||(e[14]=s("code",null,"guests",-1)),e[15]||(e[15]=a(": same as ")),n(i,{to:"/developer/bigquery/users.html"},{default:l(()=>e[13]||(e[13]=[s("code",null,"users",-1)])),_:1}),e[16]||(e[16]=a(" but with ")),e[17]||(e[17]=s("code",null,"guest_uid",-1)),e[18]||(e[18]=a(" as the private key instead of ")),e[19]||(e[19]=s("code",null,"roar_uid",-1))]),s("li",null,[e[21]||(e[21]=s("code",null,"guest_runs",-1)),e[22]||(e[22]=a(": same as ")),n(i,{to:"/developer/bigquery/user_runs.html"},{default:l(()=>e[20]||(e[20]=[s("code",null,"user_runs",-1)])),_:1}),e[23]||(e[23]=a(" but with the foreign key ")),e[24]||(e[24]=s("code",null,"guest_uid",-1)),e[25]||(e[25]=a(" instead of ")),e[26]||(e[26]=s("code",null,"roar_uid",-1))]),s("li",null,[e[28]||(e[28]=s("code",null,"guest_trials",-1)),e[29]||(e[29]=a(": same as ")),n(i,{to:"/developer/bigquery/user_trials.html"},{default:l(()=>e[27]||(e[27]=[s("code",null,"user_trials",-1)])),_:1}),e[30]||(e[30]=a(" but with the foreign key ")),e[31]||(e[31]=s("code",null,"guest_uid",-1)),e[32]||(e[32]=a(" instead of ")),e[33]||(e[33]=s("code",null,"roar_uid",-1))])]),e[39]||(e[39]=u(`<p>In each of these schema tables linked above, the columns &quot;Field name,&quot; &quot;Data type,&quot; and &quot;Description&quot; are self-explanatory. The &quot;Key type&quot; column indicates whether the field is a primary key (PK), unique key (UK), foreign key (FK), or none. A primary key uniquely identified each row in a table and cannot be <code>NULL</code>. A foreign key is references the primary key of another table. It establishes a relationship between two tables. A unique key is unique across all rows but can allow <code>NULL</code> values.</p><h2 id="installation-and-initialization" tabindex="-1"><a class="header-anchor" href="#installation-and-initialization"><span>Installation and initialization</span></a></h2><p>To query assesement data, you will need the <code>bq</code> command line tool to interact with BigQuery from your terminal. To install <code>bq</code>,</p><ol><li><p><a href="https://cloud.google.com/sdk/docs/install" target="_blank" rel="noopener noreferrer">Install the <code>gcloud</code> CLI</a></p></li><li><p><a href="https://cloud.google.com/sdk/docs/initializing" target="_blank" rel="noopener noreferrer">Initialize the <code>gcloud</code> CLI</a>. When prompted to log in with your Google account, choose your Stanford-affiliated account. When prompted to select a project, choose <code>gse-roar-assessment</code>.</p></li><li><p>Install the <code>bq</code> tool if it is not already included:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">gcloud components <span class="token function">install</span> bq</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>Verify installation:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">bq version</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><p>The initialization step above should have authenticated you into your Google account. But if you need to log in again, use</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">gcloud auth login</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Similarly, the initialization step should set a default project ID. But if you need to reset the project ID, use</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">gcloud config <span class="token builtin class-name">set</span> project gse-roar-assessment</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="querying-data" tabindex="-1"><a class="header-anchor" href="#querying-data"><span>Querying Data</span></a></h2><p>The bq tool allows you to execute SQL queries against the ROAR BigQuery tables listed above. If you are new to SQL, we recommend viewing the <a href="https://swcarpentry.github.io/sql-novice-survey/" target="_blank" rel="noopener noreferrer">Software Carpentry SQL lessons</a>. Once you are comfortable with SQL, see the examples below to guide you in querying ROAR data.</p><h3 id="querying-a-single-table" tabindex="-1"><a class="header-anchor" href="#querying-a-single-table"><span>Querying a single table</span></a></h3><div class="hint-container warning"><p class="hint-container-title">Cost Awareness</p><p>Queries in BigQuery incur costs based on the amount of data processed. Use filters and limits to minimize costs.</p><p>In the examples below, we will use <code>LIMIT 10</code> to limit our results to only 10 rows. We recommend that you do the same when refining your queries interactively. When you are satisfied with the query that you&#39;ve built, then you can remove the <code>LIMIT</code> part to get all of the results you want.</p></div><p>Research coordinators often want to query user runs. To pull 10 runs, you would use</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">bq query <span class="token parameter variable">--nouse_legacy_sql</span> <span class="token punctuation">\\</span></span>
<span class="line"><span class="token string">&#39;SELECT * FROM \`gse-roar-assessment.assessment.user_runs\` LIMIT 10&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>The output of this command is written to STDOUT so it can be difficult to parse or feed into downstream analysis. Instead, let&#39;s save the output to a JSON file. Use the format <code>prettyjson</code> for a more human readable JSON file.</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">bq query <span class="token parameter variable">--nouse_legacy_sql</span> <span class="token parameter variable">--format</span><span class="token operator">=</span>prettyjson <span class="token punctuation">\\</span></span>
<span class="line"><span class="token string">&#39;SELECT</span>
<span class="line">  *</span>
<span class="line">FROM</span>
<span class="line">  \`gse-roar-assessment.assessment.user_runs\`</span>
<span class="line">LIMIT</span>
<span class="line">  10&#39;</span> <span class="token operator">&gt;</span> output.json</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="exporting-data-to-csv" tabindex="-1"><a class="header-anchor" href="#exporting-data-to-csv"><span>Exporting data to CSV</span></a></h3><p>Researchers often want to export data to a CSV file. Let&#39;s see what happens when we change the format in that last query to <code>csv</code>:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">bq query <span class="token parameter variable">--nouse_legacy_sql</span> <span class="token parameter variable">--format</span><span class="token operator">=</span>csv <span class="token punctuation">\\</span></span>
<span class="line"><span class="token string">&#39;SELECT</span>
<span class="line">  *</span>
<span class="line">FROM</span>
<span class="line">  \`gse-roar-assessment.assessment.user_runs\`</span>
<span class="line">LIMIT</span>
<span class="line">  10&#39;</span> <span class="token operator">&gt;</span> output.csv</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>That command does create an <code>ouput.csv</code> file but if we inspect the contents, we see</p><div class="language-txt line-numbers-mode" data-highlighter="prismjs" data-ext="txt" data-title="txt"><pre><code><span class="line">Error printing table: Cannot print repeated field &quot;assigning_districts&quot; in CSV</span>
<span class="line">format.</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>The <code>assigning_districts</code> field has the data type <code>ARRAY&lt;STRING&gt;</code>. Since CSV is a flat file format and cannot directly represent nested structures like arrays.</p><h4 id="selecting-and-excluding-fields" tabindex="-1"><a class="header-anchor" href="#selecting-and-excluding-fields"><span>Selecting and excluding fields</span></a></h4><p>One way to get around this limitation is to select only flattened fields. We can explicitly select certain field from the <code>user_runs</code> table:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">bq query <span class="token parameter variable">--nouse_legacy_sql</span> <span class="token parameter variable">--format</span><span class="token operator">=</span>csv <span class="token punctuation">\\</span></span>
<span class="line"><span class="token string">&#39;SELECT</span>
<span class="line">  roar_uid, run_id, reliable</span>
<span class="line">FROM</span>
<span class="line">  \`gse-roar-assessment.assessment.user_runs\`</span>
<span class="line">LIMIT</span>
<span class="line">  10&#39;</span> <span class="token operator">&gt;</span> output.csv</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Or we can exclude the troublesome fields and select all remaining fields using <code>EXCEPT</code>:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">bq query <span class="token parameter variable">--nouse_legacy_sql</span> <span class="token parameter variable">--format</span><span class="token operator">=</span>csv <span class="token punctuation">\\</span></span>
<span class="line"><span class="token string">&#39;SELECT</span>
<span class="line">  * EXCEPT(</span>
<span class="line">    assigning_districts,</span>
<span class="line">    assigning_schools,</span>
<span class="line">    assigning_classes,</span>
<span class="line">    assigning_groups,</span>
<span class="line">    assigning_families</span>
<span class="line">  )</span>
<span class="line">FROM</span>
<span class="line">  \`gse-roar-assessment.assessment.user_runs\`</span>
<span class="line">LIMIT</span>
<span class="line">  10&#39;</span> <span class="token operator">&gt;</span> output.csv</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="flattening-nested-fields" tabindex="-1"><a class="header-anchor" href="#flattening-nested-fields"><span>Flattening nested fields</span></a></h4><p>That works, but what if we actually want the data in those nested fields? We have options here as well. We can &quot;stringify&quot; the array fields, converting them into a JSON-like string:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">bq query <span class="token parameter variable">--nouse_legacy_sql</span> <span class="token parameter variable">--format</span><span class="token operator">=</span>csv <span class="token punctuation">\\</span></span>
<span class="line"><span class="token string">&#39;SELECT</span>
<span class="line">  * EXCEPT(</span>
<span class="line">    assigning_districts,</span>
<span class="line">    assigning_schools,</span>
<span class="line">    assigning_classes,</span>
<span class="line">    assigning_groups,</span>
<span class="line">    assigning_families</span>
<span class="line">  ),</span>
<span class="line">  TO_JSON_STRING(assigning_districts) as assigning_districts,</span>
<span class="line">  TO_JSON_STRING(assigning_schools) as assigning_schools,</span>
<span class="line">  TO_JSON_STRING(assigning_classes) as assigning_classes,</span>
<span class="line">  TO_JSON_STRING(assigning_groups) as assigning_groups,</span>
<span class="line">  TO_JSON_STRING(assigning_families) as assigning_families,</span>
<span class="line">FROM</span>
<span class="line">  \`gse-roar-assessment.assessment.user_runs\`</span>
<span class="line">LIMIT</span>
<span class="line">  10&#39;</span> <span class="token operator">&gt;</span> output.csv</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="using-the-where-clause" tabindex="-1"><a class="header-anchor" href="#using-the-where-clause"><span>Using the WHERE clause</span></a></h3><p>You can use the <code>WHERE</code> clause to filter results. For example, to select only runs with the task ID &quot;swr&quot;, use</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">bq query <span class="token parameter variable">--nouse_legacy_sql</span> <span class="token parameter variable">--format</span><span class="token operator">=</span>csv <span class="token punctuation">\\</span></span>
<span class="line"><span class="token string">&#39;SELECT</span>
<span class="line">  roar_uid, run_id, task_id</span>
<span class="line">FROM</span>
<span class="line">  \`gse-roar-assessment.assessment.user_runs\`</span>
<span class="line">WHERE</span>
<span class="line">  task_id = &quot;swr&quot;</span>
<span class="line">LIMIT</span>
<span class="line">  10&#39;</span> <span class="token operator">&gt;</span> output.csv</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You can use the <code>AND</code> keywork to create compound filters. For example, you could query all &quot;swr&quot; runs that were started after a certain date using</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">bq query <span class="token parameter variable">--nouse_legacy_sql</span> <span class="token parameter variable">--format</span><span class="token operator">=</span>csv <span class="token punctuation">\\</span></span>
<span class="line"><span class="token string">&#39;SELECT</span>
<span class="line">  roar_uid, run_id, task_id, time_started</span>
<span class="line">FROM</span>
<span class="line">  \`gse-roar-assessment.assessment.user_runs\`</span>
<span class="line">WHERE</span>
<span class="line">  task_id = &quot;swr&quot;</span>
<span class="line">AND</span>
<span class="line">  time_started &gt; &quot;2024-08-08&quot;</span>
<span class="line">LIMIT</span>
<span class="line">  10&#39;</span> <span class="token operator">&gt;</span> output.csv</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="sorting-results" tabindex="-1"><a class="header-anchor" href="#sorting-results"><span>Sorting results</span></a></h3><p>You can use the <code>ORDER BY</code> clause to sort your results. For example, you can sort the results in the last query by time_started using</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">bq query <span class="token parameter variable">--nouse_legacy_sql</span> <span class="token parameter variable">--format</span><span class="token operator">=</span>csv <span class="token punctuation">\\</span></span>
<span class="line"><span class="token string">&#39;SELECT</span>
<span class="line">  roar_uid, run_id, task_id, time_started</span>
<span class="line">FROM</span>
<span class="line">  \`gse-roar-assessment.assessment.user_runs\`</span>
<span class="line">WHERE</span>
<span class="line">  task_id = &quot;swr&quot;</span>
<span class="line">AND</span>
<span class="line">  time_started &gt; &quot;2024-08-08&quot;</span>
<span class="line">ORDER BY</span>
<span class="line">  time_started ASC</span>
<span class="line">LIMIT</span>
<span class="line">  10&#39;</span> <span class="token operator">&gt;</span> output.csv</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Note that we used the <code>ASC</code> keyword to sort the results in ascending order. To reverse that and sort results in descending order, use <code>DESC</code>. For example, a very popular and useful query for researchers it to request the 10 most recent runs for a given task ID:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">bq query <span class="token parameter variable">--nouse_legacy_sql</span> <span class="token parameter variable">--format</span><span class="token operator">=</span>csv <span class="token punctuation">\\</span></span>
<span class="line"><span class="token string">&#39;SELECT</span>
<span class="line">  roar_uid, run_id, task_id, time_started</span>
<span class="line">FROM</span>
<span class="line">  \`gse-roar-assessment.assessment.user_runs\`</span>
<span class="line">WHERE</span>
<span class="line">  task_id = &quot;swr&quot;</span>
<span class="line">ORDER BY</span>
<span class="line">  time_started DESC</span>
<span class="line">LIMIT</span>
<span class="line">  10&#39;</span> <span class="token operator">&gt;</span> output.csv</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="querying-array-fields" tabindex="-1"><a class="header-anchor" href="#querying-array-fields"><span>Querying array fields</span></a></h3><p>You can use the <code>UNNEST()</code> keyword to access the elements of an array field. This will allow you to query based on values that appear in those arrays. In this example, we want to retireve 10 records from the user_runs table where the user was assigned to the school with ID &quot;uSpviE1t4lUzH8J7I9aQ&quot;.</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">bq query <span class="token parameter variable">--nouse_legacy_sql</span> <span class="token parameter variable">--format</span><span class="token operator">=</span>csv <span class="token punctuation">\\</span></span>
<span class="line"><span class="token string">&#39;SELECT</span>
<span class="line">  roar_uid, run_id, task_id, time_started,</span>
<span class="line">  TO_JSON_STRING(assigning_schools) as assigning_school</span>
<span class="line">FROM</span>
<span class="line">  \`gse-roar-assessment.assessment.user_runs\`</span>
<span class="line">WHERE</span>
<span class="line">  &quot;uSpviE1t4lUzH8J7I9aQ&quot; IN UNNEST(assigning_schools)</span>
<span class="line">ORDER BY</span>
<span class="line">  time_started DESC</span>
<span class="line">LIMIT</span>
<span class="line">  10&#39;</span> <span class="token operator">&gt;</span> output.csv</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Note that we use <code>UNNEST</code> in the <code>WHERE</code> clause and still have to use <code>TO_JSON_STRING</code> to flatten the <code>assigning_schools</code> column as above.</p><h3 id="advanced-queries-that-use-multiple-tables" tabindex="-1"><a class="header-anchor" href="#advanced-queries-that-use-multiple-tables"><span>Advanced queries that use multiple tables</span></a></h3><p>All of our examples so far have queried only one table at a time. However, some queries require referencing multiple tables. For example, the <code>user_trials</code> table has a foreign key called <code>roar_uid</code> that references the private key <code>roar_uid</code> in the <code>users</code> table. But researchers don&#39;t always know the <code>roar_uid</code> of a particular user. They may instead want to query by the <code>assessment_pid</code> in the <code>users</code> table.</p><p>To query across multiple tables in BigQuery where you need to match a foreign key (<code>roar_uid</code>) from one table (<code>user_trials</code>) with a private key in another table (<code>users</code>), and filter based on a unique key (<code>assessment_pid</code>), you can use a <code>JOIN</code> clause. In the below example, we query for 10 trials from the user with PID &quot;efschl-shs-a05c9862&quot;.</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">bq query <span class="token parameter variable">--nouse_legacy_sql</span> <span class="token parameter variable">--format</span><span class="token operator">=</span>csv <span class="token punctuation">\\</span></span>
<span class="line"><span class="token string">&#39;SELECT ut.*, u.assessment_pid</span>
<span class="line"> FROM \`gse-roar-assessment.assessment.user_trials\` AS ut</span>
<span class="line"> JOIN \`gse-roar-assessment.assessment.users\` AS u</span>
<span class="line">   ON ut.roar_uid = u.roar_uid</span>
<span class="line"> WHERE u.assessment_pid = &quot;efschl-shs-a05c9862&quot;</span>
<span class="line"> LIMIT 10&#39;</span> <span class="token operator">&gt;</span> output.csv</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This last query introduced a few new concepts so let&#39;s break it down.</p><ul><li>The <code>SELECT</code> clause selects which columns to include in the results.</li><li>We use the <code>JOIN</code> keyword to join two tables together into one.</li><li>While doing so, we use the <code>AS</code> keyword to refer to each table by a shortened variable name. So the <code>user_trials</code> table is assigned the alias <code>ut</code> and the <code>users</code> table is assigned the alias <code>u</code>.</li><li>We use the <code>ON</code> keyword to identify the column names on which to join the two tables.</li><li>The <code>JOIN</code>, <code>AS</code>, and <code>ON</code> clauses combine to defined a new table from which to select data. This joined table becomes the argument to the <code>FROM</code> keyword.</li><li>Finally, we use the <code>WHERE</code> keyword as before to filter results to the requested PID.</li></ul><p>Similarly, you could combine three different tables by chaining multiple <code>JOIN</code> clauses together. Let&#39;s combine the <code>users</code>, <code>user_runs</code>, and <code>user_trials</code> tables. Start by recognizing that the <code>users</code> and <code>user_runs</code> tables are linked by the <code>roar_uid</code> column. Similarly, the <code>user_runs</code> and <code>user_trials</code> columns are linked by the <code>run_id</code> column. Then the order of these joins should reflect the logical relationships between these tables:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">bq query <span class="token parameter variable">--nouse_legacy_sql</span> <span class="token parameter variable">--format</span><span class="token operator">=</span>csv <span class="token punctuation">\\</span></span>
<span class="line"><span class="token string">&#39;SELECT ut.*, u.assessment_pid, ur.scores</span>
<span class="line">FROM \`gse-roar-assessment.assessment.users\` AS u</span>
<span class="line">JOIN \`gse-roar-assessment.assessment.user_runs\` AS ur</span>
<span class="line">  ON u.roar_uid = ur.roar_uid</span>
<span class="line">JOIN \`gse-roar-assessment.assessment.user_trials\` AS ut</span>
<span class="line">  ON ur.run_id = ut.run_id</span>
<span class="line">LIMIT 10&#39;</span> <span class="token operator">&gt;</span> output.csv</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="exporting-large-queries-to-a-google-cloud-bucket" tabindex="-1"><a class="header-anchor" href="#exporting-large-queries-to-a-google-cloud-bucket"><span>Exporting large queries to a google cloud bucket</span></a></h3><p>For large datasets, it’s more efficient to export query results directly to a Google Cloud Storage (GCS) bucket. This has a few benefits</p><ul><li>Handling of large datasets: GCS can handle large datasets that might exceed the limits of local storage or network speed. Large files won&#39;t impact local disk space or system performance.</li><li>Cost-effectiveness: Avoid repeated query costs by exporting the results once and reusing data.</li><li>Sharing and collaboration: GCS facilitates data sharing with team members or external collaborators. You can grant specific access to a GCS bucket or file to external collaborators without sharing your local system.</li></ul><div class="hint-container warning"><p class="hint-container-title">Follow the naming conventions</p><p>In the steps below, you will create GCS buckets to which to export data. In order to avoid name collisions, please read the below naming conventions thoroughly and follow the conventions strictly. The ROAR dev team will periodically audit the bucket names reserves the right to delete any buckets that do not follow the naming convention.</p></div><p>Exporting to a GCS Bucket requires a few steps.</p><ol><li><p>Create a Google Cloud Storage bucket</p><p>The first step in exporting query results to a GCS bucket is to create a bucket. You MUST adopt the following naming convention when creating export buckets: <code>BUCKET_NAME = roar-bq-export_[IDENTIFIER]</code>. If your GCS bucket is for your own personal use, <code>IDENTIFIER</code> must be the string <code>internal_</code> followed by your SUNet ID. For example, Adam&#39;s bucket name would be <code>roar-bq-export_internal_adamrh</code>. If the bucket is for export to an external collaborator, the <code>IDENTIFIER</code> must be the string <code>external_</code> followed by the name of that organization. For example, a bucket that will be shared with collaborators at the Basque Center on Cognition, Brain, and Language (BCBL) would be named <code>roar-bq-export_external_bcbl</code>. In the commands below, replace <code>BUCKET_NAME</code> with the actual bucket name.</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">gcloud storage buckets create gs://<span class="token punctuation">[</span>BUCKET_NAME<span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>Export query results to the bucket</p><p>Next, we use the <code>EXPORT DATA</code> keywords to tell BigQuery where to export the data. We can pass <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/export-statements#gcs_s3_export_option" target="_blank" rel="noopener noreferrer">export options</a> using the <code>OPTIONS</code> keyword. In the example below, we tell BigQuery to export a csv file, overwrite existing files if necessary, and we specificy a wildcard pattern to use to name the exported files. You MUST use the following filename format: <code>FILENAME = [DATE]_[DESCRIPTION]_*.[EXT]</code>, where <code>DATE</code> is an <a href="https://en.wikipedia.org/wiki/ISO_8601" target="_blank" rel="noopener noreferrer">ISO 8601</a> date string for the export date in the format &quot;YYYY-MM-DD&quot;, <code>DESCRIPTION</code> is a hyphen-delimited human readable description of the file contents, and <code>EXT</code> is a fiile extension, usually <code>csv</code> but it could also be <code>avro</code>, <code>json</code>, or <code>parquet</code> if desired.</p><p>Note that the filename must contain a single wildcard character <code>*</code>. This requirement comes from Google&#39;s BigQuery and cannot be avoided. BigQuery will &quot;shard&quot; your exported data into multiple files if the exported data is greater than 1GB in size. So the parameter <code>uri=&quot;gs://bucket-name/YYYY-MM-DD_description_*.csv&quot;</code> will create the files</p><div class="language-txt line-numbers-mode" data-highlighter="prismjs" data-ext="txt" data-title="txt"><pre><code><span class="line">gs://bucket-name/YYYY-MM-DD_description_000000000000.csv</span>
<span class="line">gs://bucket-name/YYYY-MM-DD_description_000000000001.csv</span>
<span class="line">gs://bucket-name/YYYY-MM-DD_description_000000000002.csv</span>
<span class="line">...</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Let&#39;s put this all together by taking the <a href="#flattening-nested-fields"><code>UNNEST</code> example query</a> from above and exporting it to a bucket.</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">bq query <span class="token parameter variable">--nouse_legacy_sql</span> <span class="token punctuation">\\</span></span>
<span class="line"><span class="token string">&#39;EXPORT DATA</span>
<span class="line">OPTIONS(</span>
<span class="line">  uri=&quot;gs://[BUCKET_NAME]/2024-12-11_school-name-export_*.csv&quot;,</span>
<span class="line">  format=&quot;csv&quot;,</span>
<span class="line">  overwrite=true</span>
<span class="line">) AS</span>
<span class="line">SELECT</span>
<span class="line">  roar_uid, run_id, task_id, time_started,</span>
<span class="line">  TO_JSON_STRING(assigning_schools) as assigning_school</span>
<span class="line">FROM</span>
<span class="line">  \`gse-roar-assessment.assessment.user_runs\`</span>
<span class="line">WHERE</span>
<span class="line">  &quot;uSpviE1t4lUzH8J7I9aQ&quot; IN UNNEST(assigning_schools)</span>
<span class="line">ORDER BY</span>
<span class="line">  time_started DESC</span>
<span class="line">LIMIT</span>
<span class="line">  10&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>If the query results are less than 1GB in size, this will create one file at <code>gs://[BUCKET_NAME]/2024-12-11_school-name-export_000000000000.csv</code> with the query results.</p></li></ol>`,58))])}const g=o(p,[["render",m],["__file","index.html.vue"]]),b=JSON.parse('{"path":"/developer/bigquery/","title":"Querying Assessment Data","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"Tables and Views","slug":"tables-and-views","link":"#tables-and-views","children":[]},{"level":2,"title":"Installation and initialization","slug":"installation-and-initialization","link":"#installation-and-initialization","children":[]},{"level":2,"title":"Querying Data","slug":"querying-data","link":"#querying-data","children":[{"level":3,"title":"Querying a single table","slug":"querying-a-single-table","link":"#querying-a-single-table","children":[]},{"level":3,"title":"Exporting data to CSV","slug":"exporting-data-to-csv","link":"#exporting-data-to-csv","children":[]},{"level":3,"title":"Using the WHERE clause","slug":"using-the-where-clause","link":"#using-the-where-clause","children":[]},{"level":3,"title":"Sorting results","slug":"sorting-results","link":"#sorting-results","children":[]},{"level":3,"title":"Querying array fields","slug":"querying-array-fields","link":"#querying-array-fields","children":[]},{"level":3,"title":"Advanced queries that use multiple tables","slug":"advanced-queries-that-use-multiple-tables","link":"#advanced-queries-that-use-multiple-tables","children":[]},{"level":3,"title":"Exporting large queries to a google cloud bucket","slug":"exporting-large-queries-to-a-google-cloud-bucket","link":"#exporting-large-queries-to-a-google-cloud-bucket","children":[]}]}],"git":{"updatedTime":1743546779000,"contributors":[{"name":"Elijah Kelly","username":"Elijah Kelly","email":"kellyel@stanford.edu","commits":1,"url":"https://github.com/Elijah Kelly"},{"name":"Adam Richie-Halford","username":"Adam Richie-Halford","email":"richiehalford@gmail.com","commits":2,"url":"https://github.com/Adam Richie-Halford"}]},"filePathRelative":"developer/bigquery/README.md"}');export{g as comp,b as data};
