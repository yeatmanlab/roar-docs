import{_ as e,c as t,f as n,d as p,o as l,r as i}from"./app-FrdTVLMr.js";const o={};function c(d,s){const a=i("Mermaid");return l(),t("div",null,[s[0]||(s[0]=n('<h1 id="roar-users-and-organizations-technical-specification" tabindex="-1"><a class="header-anchor" href="#roar-users-and-organizations-technical-specification"><span>ROAR Users and Organizations: Technical Specification</span></a></h1><h2 id="purpose-and-scope" tabindex="-1"><a class="header-anchor" href="#purpose-and-scope"><span>Purpose and Scope</span></a></h2><p>This document defines the data model for users and the organizational hierarchy in ROAR, including support for various org types (e.g., districts, schools, classes, families, groups) and user-org relationships.</p><h2 id="system-overview" tabindex="-1"><a class="header-anchor" href="#system-overview"><span>System Overview</span></a></h2><p>ROAR supports hierarchical and non-hierarchical organizations. Users may belong to multiple orgs and may hold different roles depending on their context. This spec focuses on the representation of orgs and memberships only — permissions are handled in a separate spec.</p><h3 id="definitions" tabindex="-1"><a class="header-anchor" href="#definitions"><span>Definitions</span></a></h3><ul><li><p><strong>User</strong>: A person with a ROAR account (student, teacher, admin, etc.)</p></li><li><p><strong>Organization (Org)</strong>: A logical unit like a school or group</p></li><li><p><strong>Org Type</strong>:</p><p>ROAR supports multiple types of organizations. Each org is identified by an <code>org_type</code>, which controls its behavior, relationships, and access patterns:</p><table><thead><tr><th><code>org_type</code></th><th>Description</th></tr></thead><tbody><tr><td><code>district</code></td><td>A school district, typically the top-level administrative unit for school rostering and SSO.</td></tr><tr><td><code>school</code></td><td>An individual school (e.g., elementary, middle, high school) belonging to a district.</td></tr><tr><td><code>local</code></td><td>A city or community education authority (e.g., city early childhood services). May own one or more schools but does not imply a full district.</td></tr><tr><td><code>state</code></td><td>A state or province-level education agency (e.g., NYSED, TEA).</td></tr><tr><td><code>region</code></td><td>A multi-district cooperative, county office, or non-state regional education unit.</td></tr><tr><td><code>family</code></td><td>A parent-created organization representing a household. It contains children and parent(s).</td></tr><tr><td><code>group</code></td><td>A general-purpose user-defined org for collaboration, e.g., a teacher club, study group, or research circle.</td></tr><tr><td><code>cohort</code></td><td>A research study participant cohort, composed primarily of children enrolled via invitation codes or researcher enrollment.</td></tr></tbody></table></li><li><p><strong>Org Hierarchy</strong>: Parent-child relationships among orgs</p></li><li><p><strong>Course</strong>: A curriculum-aligned instructional offering (e.g., &quot;Grade 4 Math&quot;) that can be scheduled multiple times across different classes.</p></li><li><p><strong>Class</strong>: A scheduled instance of a course, with associated students, educators, term, and time block metadata. A class may reference a <code>course_id</code>.</p></li><li><p><strong>Term</strong>: A period of time during which classes are scheduled. Terms are used to group classes and students together for reporting and analysis.</p></li><li><p><strong>Time Block</strong>: A period of time during which a class is scheduled. Time blocks are used to group classes and students together for reporting and analysis.</p></li><li><p><strong>Role</strong>: A user’s function in an org (e.g., teacher, student, admin)</p></li><li><p><strong>Opt-out status</strong>: Whether a user has individually opted out of research. Opted out users must never be included in research data, but their data is retained in order to fulfill obligations to partners (e.g., score reporting). Once the service obligation to a partner is terminated, opted out users are permanently deleted from the database and all backups.</p></li><li><p><strong>Personally Identifiable Information (PII)</strong>: PII for education records is a FERPA term referring to identifiable information that is maintained in education records and includes direct identifiers, such as a student’s name or identification number, indirect identifiers, such as a student’s date of birth, or other information which can be used to distinguish or trace an individual’s identity either directly or indirectly through linkages with other information. See <a href="https://studentprivacy.ed.gov/ferpa" target="_blank" rel="noopener noreferrer">Family Educational Rights and Privacy Act Regulations, 34 CFR §99.3</a>, for a complete definition of PII specific to education records and for examples of other data elements that are defined to constitute PII.</p></li><li><p><strong>Invitation Codes</strong>: To support self-service linking of users (especially children) to cohorts or groups, ROAR supports invitation codes. Invitation codes are stored in the <code>invitation_codes</code> table. Codes are typically used to join cohort, group, or family orgs. Codes must not be used for district, school, or class orgs tied to official rostering. After a code is redeemed, the child is added to the org_membership table with the designated role.</p></li></ul><h3 id="component-flow-diagram" tabindex="-1"><a class="header-anchor" href="#component-flow-diagram"><span>Component Flow Diagram</span></a></h3>',8)),p(a,{id:"mermaid-164",code:"eJwdzEsKgCAURuF5q/g34BaCHjRqWCNxUHFR4ZpyjaDdp04PH8fKkRy2uQMGvWcSA6V6jHqN1t+m5LGFSS/0XA5RLAKFkyQ7n3IFUwOzHlLirwLF9BJDIhO4bC7T/UMLIAY="}),s[1]||(s[1]=n(`<h2 id="runtime-behavior" tabindex="-1"><a class="header-anchor" href="#runtime-behavior"><span>Runtime Behavior</span></a></h2><ul><li>A user may belong to multiple orgs at once.</li><li>Roles are stored per org membership. That is, a user may have different roles in different orgs.</li><li>Org hierarchies enable queries like &quot;all students in a district.&quot;</li><li>User authentication and role checks should always resolve to the canonical <code>user_id</code> after following <code>merged_into</code> pointers. This allows multiple login credentials (e.g., SSO and email) to be linked to a unified identity.</li><li>Org Type Constraints: <ul><li>family, group, and cohort orgs support flexible membership and invitation code-based joining.</li><li>district, school, and class orgs are roster-controlled. Membership must be provisioned via integrations (e.g., OneRoster API, Clever API) or trusted internal workflows (e.g., CSV upload).</li><li>Invitation codes must not grant access to roster-controlled orgs to avoid unverified role elevation.</li></ul></li></ul><h3 id="annual-pii-scrubbing" tabindex="-1"><a class="header-anchor" href="#annual-pii-scrubbing"><span>Annual PII scrubbing</span></a></h3><p>To comply with FERPA and data minimization principles, ROAR performs an annual PII scrubbing process to remove personally identifiable information (PII) for users who are no longer affiliated with any active organizations.</p><p>A user is eligible for PII scrubbing if:</p><ul><li>The user has no active <code>users_orgs</code> records (i.e., all associated <code>users_orgs.end_date</code> values are in the past)</li><li>The user has not already been scrubbed (users.pii_scrubbed_at IS NULL)</li></ul><p>For each user to be scrubbed, we take the following actions:</p><ul><li><p>In the <code>users</code> table:</p><ul><li>Nullify: <ul><li>email</li><li>username</li><li>name fields</li><li>date_of_birth</li></ul></li><li>Set <code>pii_scrubbed_at = CURRENT_TIMESTAMP</code></li></ul></li><li><p>In the <code>user_external_ids</code> table:</p><ul><li>Nullify all identifiers not explicitly retained for reporting. This includes <code>sis_id</code>, <code>state_student_id</code>, <code>clever_id</code>, <code>classlink_id</code></li><li><code>pii_scrubbed_at = CURRENT_TIMESTAMP</code></li></ul></li></ul><p>The scrub job is scheduled to run annually (e.g., each July) but it may be invoked manually or run in batches for performance. Here is SQL pseudocode for the annual scrubber:</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 1. Identify users who are eligible for scrubbing (not previously scrubbed and no current orgs).</span></span>
<span class="line"><span class="token keyword">WITH</span> scrub_candidates <span class="token keyword">AS</span> <span class="token punctuation">(</span></span>
<span class="line">  <span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>id <span class="token keyword">AS</span> user_id</span>
<span class="line">  <span class="token keyword">FROM</span> users u</span>
<span class="line">  <span class="token keyword">WHERE</span> u<span class="token punctuation">.</span>pii_scrubbed_at <span class="token operator">IS</span> <span class="token boolean">NULL</span></span>
<span class="line">    <span class="token operator">AND</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span></span>
<span class="line">      <span class="token keyword">SELECT</span> <span class="token number">1</span></span>
<span class="line">      <span class="token keyword">FROM</span> users_orgs uo</span>
<span class="line">      <span class="token keyword">WHERE</span> uo<span class="token punctuation">.</span>user_id <span class="token operator">=</span> u<span class="token punctuation">.</span>id</span>
<span class="line">        <span class="token operator">AND</span> <span class="token punctuation">(</span>uo<span class="token punctuation">.</span>end_date <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token operator">OR</span> uo<span class="token punctuation">.</span>end_date <span class="token operator">&gt;</span> <span class="token keyword">CURRENT_DATE</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 2. Scrub PII fields in the \`users\` table</span></span>
<span class="line"><span class="token keyword">UPDATE</span> users</span>
<span class="line"><span class="token keyword">SET</span></span>
<span class="line">  email <span class="token operator">=</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  username <span class="token operator">=</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  dob <span class="token operator">=</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  name_first <span class="token operator">=</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  name_last <span class="token operator">=</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  name_middle <span class="token operator">=</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  pii_scrubbed_at <span class="token operator">=</span> <span class="token keyword">CURRENT_TIMESTAMP</span></span>
<span class="line"><span class="token keyword">WHERE</span> id <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> scrub_candidates<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 3. Scrub external identifiers</span></span>
<span class="line"><span class="token keyword">UPDATE</span> user_external_ids</span>
<span class="line"><span class="token keyword">SET</span></span>
<span class="line">  <span class="token keyword">value</span> <span class="token operator">=</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  scrubbed_at <span class="token operator">=</span> <span class="token keyword">CURRENT_TIMESTAMP</span></span>
<span class="line"><span class="token keyword">WHERE</span> user_id <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> scrub_candidates<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="edge-cases-and-error-handling" tabindex="-1"><a class="header-anchor" href="#edge-cases-and-error-handling"><span>Edge Cases and Error Handling</span></a></h2><table><thead><tr><th>Scenario</th><th>Behavior</th></tr></thead><tbody><tr><td>User has no orgs</td><td>May have limited access only</td></tr><tr><td>Org with invalid <code>parent_org_id</code></td><td>400 Bad Request</td></tr><tr><td>Circular org hierarchy attempted</td><td>400 Bad Request or block at UI</td></tr><tr><td>Attempt to create or redeem invitation codes for rostered orgs</td><td>400 Bad Request</td></tr></tbody></table><h2 id="design-rationale" tabindex="-1"><a class="header-anchor" href="#design-rationale"><span>Design Rationale</span></a></h2><ul><li>A unified orgs table (as opposed to separate tables for districts, schools, etc.) keeps the model simple, flexible, and extensible.</li><li>Separate org types enable special-case logic (e.g., school vs. family).</li><li>Role scoping in <code>users_orgs</code> supports distinct permissions per org and use case.</li><li>Separating courses and classes from other orgs aligns with both OneRoster and Clever data models (N.B. Clever refers to classes as &quot;sections&quot;).</li><li>Separate courses and classes allows course reuse across multiple classes (sections).</li><li>In Clever&#39;s data model each course and class are associated with only one grade, term, period, and subject. However, in the OneRoster data model, a course can be associated with multiple grades, terms, periods, and subjects. ROAR conforms to the OneRoster model by adding many-to-many join tables for these relationships. This aligns with OneRoster and is also more expressive (e.g., it supports multi-subject interdisciplinary classes, blended grades, and rolling terms).</li><li>Separate roles per org allows nuanced modeling (e.g., teacher in one, admin in another).</li><li><code>org_type = &#39;cohort&#39;</code> enables research-specific grouping and consent control.</li><li>Invitation codes enable secure, controlled, opt-in enrollment for ROAR@Home and study use.</li><li><code>merged_into</code> allows identity unification without data loss or duplication.</li></ul><h2 id="sql-schema" tabindex="-1"><a class="header-anchor" href="#sql-schema"><span>SQL Schema</span></a></h2><h3 id="frl-status-enum" tabindex="-1"><a class="header-anchor" href="#frl-status-enum"><span><code>frl_status_enum</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TYPE</span> frl_status_enum <span class="token keyword">AS</span> <span class="token keyword">ENUM</span> <span class="token punctuation">(</span><span class="token string">&#39;free&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;reduced&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;paid&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;unknown&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="grade-levels" tabindex="-1"><a class="header-anchor" href="#grade-levels"><span><code>grade_levels</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> grade_levels <span class="token punctuation">(</span></span>
<span class="line">  name <span class="token keyword">TEXT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>         <span class="token comment">-- The normalized enum value used in ROAR</span></span>
<span class="line">  display_name <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>     <span class="token comment">-- Human-readable label for UI</span></span>
<span class="line">  order_index <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>   <span class="token comment">-- For ordered display</span></span>
<span class="line">  one_roster_equiv <span class="token keyword">TEXT</span>           <span class="token comment">-- Closest OneRoster-compatible mapping</span></span>
<span class="line">  school_level <span class="token keyword">TEXT</span> <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>school_level <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">&#39;early&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;elementary&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;middle&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;high&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;postsecondary&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;ungraded&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;other&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Here is the entire <code>grade_levels</code> table:</p><table><thead><tr><th>value</th><th>display_name</th><th>order_index</th><th>one_roster_equiv</th><th>school_level</th></tr></thead><tbody><tr><td>InfantToddler</td><td>Infant/Toddler</td><td>0</td><td>Other</td><td>early</td></tr><tr><td>Preschool</td><td>Preschool</td><td>1</td><td>Other</td><td>early</td></tr><tr><td>PreKindergarten</td><td>Pre-K</td><td>2</td><td>PK</td><td>early</td></tr><tr><td>TransitionalKindergarten</td><td>Transitional Kindergarten</td><td>3</td><td>Other</td><td>early</td></tr><tr><td>Kindergarten</td><td>Kindergarten</td><td>4</td><td>K</td><td>elementary</td></tr><tr><td>1</td><td>1st Grade</td><td>5</td><td>01</td><td>elementary</td></tr><tr><td>2</td><td>2nd Grade</td><td>6</td><td>02</td><td>elementary</td></tr><tr><td>3</td><td>3rd Grade</td><td>7</td><td>03</td><td>elementary</td></tr><tr><td>4</td><td>4th Grade</td><td>8</td><td>04</td><td>elementary</td></tr><tr><td>5</td><td>5th Grade</td><td>9</td><td>05</td><td>elementary</td></tr><tr><td>6</td><td>6th Grade</td><td>10</td><td>06</td><td>middle</td></tr><tr><td>7</td><td>7th Grade</td><td>11</td><td>07</td><td>middle</td></tr><tr><td>8</td><td>8th Grade</td><td>12</td><td>08</td><td>middle</td></tr><tr><td>9</td><td>9th Grade</td><td>13</td><td>09</td><td>high</td></tr><tr><td>10</td><td>10th Grade</td><td>14</td><td>10</td><td>high</td></tr><tr><td>11</td><td>11th Grade</td><td>15</td><td>11</td><td>high</td></tr><tr><td>12</td><td>12th Grade</td><td>16</td><td>12</td><td>high</td></tr><tr><td>13</td><td>Post-secondary</td><td>17</td><td>13</td><td>postsecondary</td></tr><tr><td>PostGraduate</td><td>Postgraduate</td><td>18</td><td>Other</td><td>postsecondary</td></tr><tr><td>Ungraded</td><td>Ungraded</td><td>19</td><td>Ungraded</td><td>ungraded</td></tr><tr><td>Other</td><td>Other</td><td>20</td><td>Other</td><td>other</td></tr></tbody></table><h3 id="users" tabindex="-1"><a class="header-anchor" href="#users"><span><code>users</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  auth_uid <span class="token keyword">TEXT</span> <span class="token keyword">UNIQUE</span><span class="token punctuation">,</span> <span class="token comment">-- Can be null on creation. Gets set when auth credentials are provisioned</span></span>
<span class="line">  username <span class="token keyword">TEXT</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  email <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">-- Name Fields</span></span>
<span class="line">  name_first <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">  name_last <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">  name_middle <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">-- Demographics</span></span>
<span class="line">  dob <span class="token keyword">DATE</span><span class="token punctuation">,</span></span>
<span class="line">  gender <span class="token keyword">TEXT</span><span class="token punctuation">,</span>               <span class="token comment">-- See enum options below</span></span>
<span class="line">  grade <span class="token keyword">TEXT</span> <span class="token keyword">REFERENCES</span> grade_levels<span class="token punctuation">(</span>name<span class="token punctuation">)</span></span>
<span class="line">  school_level <span class="token keyword">TEXT</span><span class="token punctuation">,</span>         <span class="token comment">-- Derived (elementary, middle, etc.)</span></span>
<span class="line">  hispanic_ethnicity <span class="token keyword">BOOLEAN</span><span class="token punctuation">,</span></span>
<span class="line">  race <span class="token keyword">TEXT</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>               <span class="token comment">-- Multiselect array (e.g., [&#39;White&#39;, &#39;Asian&#39;])</span></span>
<span class="line">  frl_status frl_status_enum <span class="token keyword">DEFAULT</span> <span class="token string">&#39;unknown&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  iep_status <span class="token keyword">BOOLEAN</span><span class="token punctuation">,</span></span>
<span class="line">  ell_status <span class="token keyword">BOOLEAN</span><span class="token punctuation">,</span></span>
<span class="line">  pii_scrubbed_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE<span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">-- Identifiers</span></span>
<span class="line">  pid <span class="token keyword">TEXT</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token comment">-- Human-readable unique participant ID</span></span>
<span class="line">  email <span class="token keyword">TEXT</span> <span class="token keyword">UNIQUE</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">-- Metadata</span></span>
<span class="line">  merged_into UUID <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  last_rostering_update <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  is_system_user <span class="token keyword">BOOLEAN</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>To support account linking (e.g., a parent with both a ROAR@Home and district SSO account), ROAR tracks identity merges with the <code>merged_into</code> column. If <code>merged_into IS NULL</code>, this is the canonical user account. If not null, the user record is a shadow of another user and all access should resolve to the target user.</p><p>Some tables include fields which track different users who have made changes or authorized certain actions. These could be used for audit logging and provenance tracking. However, it&#39;s common to run into cases where no human user directly initiated the action — e.g., a backend job, sync service, or webhook from Clever or another system. In these cases, we use a special &quot;system&quot; user (with <code>is_system_user</code> set to <code>true</code>) to represent the action. For example:</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name_first<span class="token punctuation">,</span> name_last<span class="token punctuation">,</span> username<span class="token punctuation">,</span> email<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> is_system_user<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">VALUES</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;00000000-0000-0000-0000-000000000001&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;System&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Automated&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;system&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;system@roar.local&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;system&#39;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;00000000-0000-0000-0000-000000000002&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Clever&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Sync&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;clever-sync&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;clever-sync@roar.local&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;clever-sync&#39;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;00000000-0000-0000-0000-000000000003&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;OneRoster&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Import&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;oneroster-import&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;oneroster-import@roar.local&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;oneroster-import&#39;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="external-id-types" tabindex="-1"><a class="header-anchor" href="#external-id-types"><span><code>external_id_types</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> external_id_types <span class="token punctuation">(</span></span>
<span class="line">  name <span class="token keyword">TEXT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>         <span class="token comment">-- e.g., &#39;clever&#39;, &#39;oneroster&#39;</span></span>
<span class="line">  display_name <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token comment">-- e.g., &#39;Clever&#39;, &#39;1EdTech OneRoster&#39;</span></span>
<span class="line">  description <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> external_id_types <span class="token punctuation">(</span>name<span class="token punctuation">,</span> display_name<span class="token punctuation">,</span> description<span class="token punctuation">)</span> <span class="token keyword">VALUES</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;clever&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Clever&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;External ID provided by the Clever platform&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;oneroster&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;1EdTech OneRoster&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;ID aligned with OneRoster spec&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;sis&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;SIS&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Student Information System ID&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;custom&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Custom ID&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Locally defined or imported identifier&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;state_id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;State ID&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;State-assigned unique student or org identifier&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;local_id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Local ID&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;District-assigned ID not tied to a formal rostering system&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;nces_id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;NCES ID&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;NCES-assigned unique identifier&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;mdr_number&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;MDR Number&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;MDR-assigned unique identifier&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="user-external-ids" tabindex="-1"><a class="header-anchor" href="#user-external-ids"><span><code>user_external_ids</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_external_ids <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  user_id UUID <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  external_id <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  external_id_type <span class="token keyword">TEXT</span> <span class="token keyword">REFERENCES</span> external_id_types<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  pii_scrubbed_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE<span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> external_id_type<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="org-types" tabindex="-1"><a class="header-anchor" href="#org-types"><span><code>org_types</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> org_types <span class="token punctuation">(</span></span>
<span class="line">  name <span class="token keyword">TEXT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></span>
<span class="line">  one_roster_equiv <span class="token keyword">TEXT</span> <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>one_roster_equiv <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">&#39;state&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;region&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;district&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;school&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;local&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;other&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- Seed values</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> org_types <span class="token punctuation">(</span>name<span class="token punctuation">,</span> one_roster_equiv<span class="token punctuation">)</span> <span class="token keyword">VALUES</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;district&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;district&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;school&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;school&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;local&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;local&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;state&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;state&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;region&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;region&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;family&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;other&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;group&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;other&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token string">&#39;cohort&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;other&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="orgs" tabindex="-1"><a class="header-anchor" href="#orgs"><span><code>orgs</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> orgs <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  name <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  org_type <span class="token keyword">TEXT</span> <span class="token keyword">REFERENCES</span> org_types<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  parent_org_id UUID <span class="token keyword">REFERENCES</span> orgs<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">SET</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">-- Location</span></span>
<span class="line">  location_address_line1 <span class="token keyword">TEXT</span><span class="token punctuation">;</span></span>
<span class="line">  location_address_line2 <span class="token keyword">TEXT</span><span class="token punctuation">;</span></span>
<span class="line">  location_city <span class="token keyword">TEXT</span><span class="token punctuation">;</span></span>
<span class="line">  location_state_province <span class="token keyword">TEXT</span><span class="token punctuation">;</span></span>
<span class="line">  location_postal_code <span class="token keyword">TEXT</span><span class="token punctuation">;</span></span>
<span class="line">  location_country <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;US&#39;</span><span class="token punctuation">;</span>  <span class="token comment">-- ISO 3166-1 alpha-2</span></span>
<span class="line">  location_timezone <span class="token keyword">TEXT</span><span class="token punctuation">;</span></span>
<span class="line">  location_lat <span class="token keyword">NUMERIC</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  location_long <span class="token keyword">NUMERIC</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">-- Metadata</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="org-external-ids" tabindex="-1"><a class="header-anchor" href="#org-external-ids"><span><code>org_external_ids</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> org_external_ids <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  org_id UUID <span class="token keyword">REFERENCES</span> orgs<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  external_id <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  external_id_type <span class="token keyword">TEXT</span> <span class="token keyword">REFERENCES</span> external_id_types<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>org_id<span class="token punctuation">,</span> external_id_type<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="users-orgs" tabindex="-1"><a class="header-anchor" href="#users-orgs"><span><code>users_orgs</code></span></a></h3><p>The <code>users_orgs</code> table links users to orgs with a role. A user can belong to multiple orgs of different types (e.g., a child can be in a family, a class, and a cohort).</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users_orgs <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  user_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  org_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> orgs<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  role <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> roles<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  start_date <span class="token keyword">DATE</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_DATE</span><span class="token punctuation">,</span></span>
<span class="line">  end_date <span class="token keyword">DATE</span><span class="token punctuation">,</span> <span class="token comment">-- NULL means currently active</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> org_id<span class="token punctuation">,</span> role<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="courses" tabindex="-1"><a class="header-anchor" href="#courses"><span><code>courses</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> courses <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  org_id UUID <span class="token keyword">REFERENCES</span> orgs<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  name <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  number <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>org_id<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="course-grades" tabindex="-1"><a class="header-anchor" href="#course-grades"><span><code>course_grades</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> course_grades <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  course_id UUID <span class="token keyword">REFERENCES</span> courses<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  grade <span class="token keyword">TEXT</span> <span class="token keyword">REFERENCES</span> grade_levels<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>course_id<span class="token punctuation">,</span> grade<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="course-subjects" tabindex="-1"><a class="header-anchor" href="#course-subjects"><span><code>course_subjects</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> course_subjects <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  course_id UUID <span class="token keyword">REFERENCES</span> courses<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  subject <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>course_id<span class="token punctuation">,</span> subject<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="terms" tabindex="-1"><a class="header-anchor" href="#terms"><span><code>terms</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> terms <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  org_id UUID <span class="token keyword">REFERENCES</span> orgs<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  name <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">  start_date <span class="token keyword">DATE</span><span class="token punctuation">,</span></span>
<span class="line">  end_date <span class="token keyword">DATE</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>org_id<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="classes" tabindex="-1"><a class="header-anchor" href="#classes"><span><code>classes</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> classes <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  org_id UUID <span class="token keyword">REFERENCES</span> orgs<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  school_id UUID <span class="token keyword">REFERENCES</span> orgs<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  district_id UUID <span class="token keyword">REFERENCES</span> orgs<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  course_id UUID <span class="token keyword">REFERENCES</span> courses<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  class_type <span class="token keyword">TEXT</span> <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>class_type <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">&#39;homeroom&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;scheduled&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;other&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  name <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  number <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">  term_id UUID <span class="token keyword">REFERENCES</span> terms<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  period <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="class-grades" tabindex="-1"><a class="header-anchor" href="#class-grades"><span><code>class_grades</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> class_grades <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  class_id UUID <span class="token keyword">REFERENCES</span> classes<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  grade <span class="token keyword">TEXT</span> <span class="token keyword">REFERENCES</span> grade_levels<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>class_id<span class="token punctuation">,</span> grade<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="class-subjects" tabindex="-1"><a class="header-anchor" href="#class-subjects"><span><code>class_subjects</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> class_subjects <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  class_id UUID <span class="token keyword">REFERENCES</span> classes<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  subject <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>class_id<span class="token punctuation">,</span> subject<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="class-terms" tabindex="-1"><a class="header-anchor" href="#class-terms"><span><code>class_terms</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> class_terms <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  class_id UUID <span class="token keyword">REFERENCES</span> classes<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  term_id UUID <span class="token keyword">REFERENCES</span> terms<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>class_id<span class="token punctuation">,</span> term_id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="class-periods" tabindex="-1"><a class="header-anchor" href="#class-periods"><span><code>class_periods</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> class_periods <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  class_id UUID <span class="token keyword">REFERENCES</span> classes<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  period <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>class_id<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="invitation-codes" tabindex="-1"><a class="header-anchor" href="#invitation-codes"><span><code>invitation_codes</code></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> invitation_codes <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  code <span class="token keyword">TEXT</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  org_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> orgs<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  role <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> roles<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  expires_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  max_uses <span class="token keyword">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">  used_count <span class="token keyword">INTEGER</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">  created_by UUID <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  deleted_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="api-contract" tabindex="-1"><a class="header-anchor" href="#api-contract"><span>API Contract</span></a></h2><h3 id="create-an-org" tabindex="-1"><a class="header-anchor" href="#create-an-org"><span>Create an org</span></a></h3><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">POST /api/orgs</span>
<span class="line">{</span>
<span class="line">  &quot;name&quot;: &quot;Lincoln High&quot;,</span>
<span class="line">  &quot;org_type&quot;: &quot;school&quot;,</span>
<span class="line">  &quot;parent_org_id&quot;: &quot;uuid-of-district&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="update-an-org" tabindex="-1"><a class="header-anchor" href="#update-an-org"><span>Update an org</span></a></h3><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">PATCH /api/orgs/:id</span>
<span class="line">{</span>
<span class="line">  &quot;name&quot;: &quot;Lincoln High&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="list-orgs" tabindex="-1"><a class="header-anchor" href="#list-orgs"><span>List orgs</span></a></h3><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">GET /api/orgs</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="get-an-org" tabindex="-1"><a class="header-anchor" href="#get-an-org"><span>Get an org</span></a></h3><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">GET /api/orgs/:id</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="add-a-user-to-an-org" tabindex="-1"><a class="header-anchor" href="#add-a-user-to-an-org"><span>Add a user to an org</span></a></h3><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">POST /api/user-orgs</span>
<span class="line">{</span>
<span class="line">  &quot;user_id&quot;: &quot;uuid&quot;,</span>
<span class="line">  &quot;org_id&quot;: &quot;uuid&quot;,</span>
<span class="line">  &quot;role&quot;: &quot;teacher&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="remove-a-user-from-an-org" tabindex="-1"><a class="header-anchor" href="#remove-a-user-from-an-org"><span>Remove a user from an org</span></a></h3><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">DELETE /api/user-orgs/:user_id/:org_id</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="list-user-org-memberships" tabindex="-1"><a class="header-anchor" href="#list-user-org-memberships"><span>List user-org memberships</span></a></h3><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">GET /api/users</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="get-a-user" tabindex="-1"><a class="header-anchor" href="#get-a-user"><span>Get a user</span></a></h3><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">GET /api/users/:id</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="create-a-user" tabindex="-1"><a class="header-anchor" href="#create-a-user"><span>Create a user</span></a></h3><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">POST /api/users</span>
<span class="line">{</span>
<span class="line">  &quot;name&quot;: &quot;John Doe&quot;,</span>
<span class="line">  &quot;email&quot;: &quot;john.doe@example.com&quot;,</span>
<span class="line">  &quot;password&quot;: &quot;password&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="update-a-user" tabindex="-1"><a class="header-anchor" href="#update-a-user"><span>Update a user</span></a></h3><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">PATCH /api/users/:id</span>
<span class="line">{</span>
<span class="line">  &quot;name&quot;: &quot;John Doe&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="merge-users" tabindex="-1"><a class="header-anchor" href="#merge-users"><span>Merge users</span></a></h3><p>Performs identity merge and updates <code>merged_into</code>.</p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">POST /api/admin/users/merge</span>
<span class="line">{</span>
<span class="line">  &quot;from_user_id&quot;: &quot;uuid-home&quot;,</span>
<span class="line">  &quot;into_user_id&quot;: &quot;uuid-ssologin&quot;,</span>
<span class="line">  &quot;justification&quot;: &quot;User authenticated in both systems&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="redeem-an-invitation-code" tabindex="-1"><a class="header-anchor" href="#redeem-an-invitation-code"><span>Redeem an invitation code</span></a></h3><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">POST /api/invitations/redeem</span>
<span class="line">{</span>
<span class="line">  &quot;code&quot;: &quot;study-a-code&quot;,</span>
<span class="line">  &quot;child_id&quot;: &quot;uuid-of-child&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Returns success or an error if the code is invalid, expired, or not applicable to the given child.</p><h2 id="migration-plan" tabindex="-1"><a class="header-anchor" href="#migration-plan"><span>Migration Plan</span></a></h2><ul><li>Migrate current users and roles into the unified membership model</li><li>Assign default roles where missing</li><li>Migrate the Firestore org collections (<code>districts</code>, <code>schools</code>, <code>families</code>, <code>groups</code>) into the <code>orgs</code> table.</li><li>Migrate the Firestore user-org relationships (currently stored in the <code>users</code> collection) into the <code>users_orgs</code> table.</li><li>Populate org_type based on known groupings.</li></ul><h2 id="summary" tabindex="-1"><a class="header-anchor" href="#summary"><span>Summary</span></a></h2><p>This spec formalizes a scalable and flexible representation of users and their relationships to hierarchical and non-hierarchical organizations.</p>`,90))])}const u=e(o,[["render",c],["__file","users-orgs.html.vue"]]),k=JSON.parse('{"path":"/developer/tech-specs/backend/users-orgs.html","title":"ROAR Users and Organizations: Technical Specification","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"Purpose and Scope","slug":"purpose-and-scope","link":"#purpose-and-scope","children":[]},{"level":2,"title":"System Overview","slug":"system-overview","link":"#system-overview","children":[{"level":3,"title":"Definitions","slug":"definitions","link":"#definitions","children":[]},{"level":3,"title":"Component Flow Diagram","slug":"component-flow-diagram","link":"#component-flow-diagram","children":[]}]},{"level":2,"title":"Runtime Behavior","slug":"runtime-behavior","link":"#runtime-behavior","children":[{"level":3,"title":"Annual PII scrubbing","slug":"annual-pii-scrubbing","link":"#annual-pii-scrubbing","children":[]}]},{"level":2,"title":"Edge Cases and Error Handling","slug":"edge-cases-and-error-handling","link":"#edge-cases-and-error-handling","children":[]},{"level":2,"title":"Design Rationale","slug":"design-rationale","link":"#design-rationale","children":[]},{"level":2,"title":"SQL Schema","slug":"sql-schema","link":"#sql-schema","children":[{"level":3,"title":"frl_status_enum","slug":"frl-status-enum","link":"#frl-status-enum","children":[]},{"level":3,"title":"grade_levels","slug":"grade-levels","link":"#grade-levels","children":[]},{"level":3,"title":"users","slug":"users","link":"#users","children":[]},{"level":3,"title":"external_id_types","slug":"external-id-types","link":"#external-id-types","children":[]},{"level":3,"title":"user_external_ids","slug":"user-external-ids","link":"#user-external-ids","children":[]},{"level":3,"title":"org_types","slug":"org-types","link":"#org-types","children":[]},{"level":3,"title":"orgs","slug":"orgs","link":"#orgs","children":[]},{"level":3,"title":"org_external_ids","slug":"org-external-ids","link":"#org-external-ids","children":[]},{"level":3,"title":"users_orgs","slug":"users-orgs","link":"#users-orgs","children":[]},{"level":3,"title":"courses","slug":"courses","link":"#courses","children":[]},{"level":3,"title":"course_grades","slug":"course-grades","link":"#course-grades","children":[]},{"level":3,"title":"course_subjects","slug":"course-subjects","link":"#course-subjects","children":[]},{"level":3,"title":"terms","slug":"terms","link":"#terms","children":[]},{"level":3,"title":"classes","slug":"classes","link":"#classes","children":[]},{"level":3,"title":"class_grades","slug":"class-grades","link":"#class-grades","children":[]},{"level":3,"title":"class_subjects","slug":"class-subjects","link":"#class-subjects","children":[]},{"level":3,"title":"class_terms","slug":"class-terms","link":"#class-terms","children":[]},{"level":3,"title":"class_periods","slug":"class-periods","link":"#class-periods","children":[]},{"level":3,"title":"invitation_codes","slug":"invitation-codes","link":"#invitation-codes","children":[]}]},{"level":2,"title":"API Contract","slug":"api-contract","link":"#api-contract","children":[{"level":3,"title":"Create an org","slug":"create-an-org","link":"#create-an-org","children":[]},{"level":3,"title":"Update an org","slug":"update-an-org","link":"#update-an-org","children":[]},{"level":3,"title":"List orgs","slug":"list-orgs","link":"#list-orgs","children":[]},{"level":3,"title":"Get an org","slug":"get-an-org","link":"#get-an-org","children":[]},{"level":3,"title":"Add a user to an org","slug":"add-a-user-to-an-org","link":"#add-a-user-to-an-org","children":[]},{"level":3,"title":"Remove a user from an org","slug":"remove-a-user-from-an-org","link":"#remove-a-user-from-an-org","children":[]},{"level":3,"title":"List user-org memberships","slug":"list-user-org-memberships","link":"#list-user-org-memberships","children":[]},{"level":3,"title":"Get a user","slug":"get-a-user","link":"#get-a-user","children":[]},{"level":3,"title":"Create a user","slug":"create-a-user","link":"#create-a-user","children":[]},{"level":3,"title":"Update a user","slug":"update-a-user","link":"#update-a-user","children":[]},{"level":3,"title":"Merge users","slug":"merge-users","link":"#merge-users","children":[]},{"level":3,"title":"Redeem an invitation code","slug":"redeem-an-invitation-code","link":"#redeem-an-invitation-code","children":[]}]},{"level":2,"title":"Migration Plan","slug":"migration-plan","link":"#migration-plan","children":[]},{"level":2,"title":"Summary","slug":"summary","link":"#summary","children":[]}],"git":{"updatedTime":1751865563000,"contributors":[{"name":"Adam Richie-Halford","username":"Adam Richie-Halford","email":"richiehalford@gmail.com","commits":7,"url":"https://github.com/Adam Richie-Halford"}]},"filePathRelative":"developer/tech-specs/backend/users-orgs.md"}');export{u as comp,k as data};
