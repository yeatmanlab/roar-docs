import{_ as e,c as t,d as s,e as i,o,r as l}from"./app-DJ04AWGL.js";const p={};function r(c,n){const a=l("Mermaid");return o(),t("div",null,[n[0]||(n[0]=s('<h1 id="roar-agreements-technical-specification" tabindex="-1"><a class="header-anchor" href="#roar-agreements-technical-specification"><span>ROAR Agreements: Technical Specification</span></a></h1><h2 id="purpose-and-scope" tabindex="-1"><a class="header-anchor" href="#purpose-and-scope"><span>Purpose and Scope</span></a></h2><p>This document defines the technical design and runtime behavior of the ROAR &quot;Agreements&quot; system. It is responsible for presenting, storing, and tracking user acceptance of various types of agreements, including Terms of Service (TOS), assent forms for minors, and consent forms for adults. The system ensures that users are only prompted to sign agreements they have not previously accepted, and it supports multiple agreement versions and translations.</p><h2 id="system-overview" tabindex="-1"><a class="header-anchor" href="#system-overview"><span>System Overview</span></a></h2><p>The Agreements system manages:</p><ul><li>Versioned agreement definitions and content</li><li>Multi-language support for agreement presentation</li><li>Per-user agreement acceptance tracking</li><li>Administration-level association with required agreements</li></ul><h3 id="definitions" tabindex="-1"><a class="header-anchor" href="#definitions"><span>Definitions</span></a></h3><ul><li><strong>Agreement Type</strong>: Assent, consent, or terms of service (TOS)</li><li><strong>Agreement</strong>: A logical category of agreement (e.g., &quot;baseline assent&quot;, &quot;eye tracking consent&quot;).</li><li><strong>Agreement Version</strong>: A specific version of an agreement with fixed legal content.</li><li><strong>Agreement Translation</strong>: A localized version of an agreement version&#39;s content.</li><li><strong>User Agreement</strong>: A record that a user has signed a particular agreement version.</li></ul><h3 id="component-flow-diagram" tabindex="-1"><a class="header-anchor" href="#component-flow-diagram"><span>Component Flow Diagram</span></a></h3>',9)),i(a,{id:"mermaid-70",code:"eJxN0MFuwjAMBuA7T+HbTrzCptHCOEy7sB2mCE1W65WINi62i4QQ707kgCDn7//zJ53guIPvegb5vIcfJQE1FFMw1P0W5vNXWITNSY0G6BlbBWyHmKKaoEVOW48uHFbhk3k/jSB0mKJQC9gJ0UDJ4EiimWvxlfv6vEaFyS+NXcqesNm9XZzUmcAXO1yGOurY4+mp8J9lgJg8/qJ5W4M9lfalh1a35+TmPPqeK2Ll4iNsjIW84u/RLNSwtAX6il9S9+tQcbKYJgLj8kGzKydZZj0="}),n[1]||(n[1]=s(`<h2 id="runtime-behavior" tabindex="-1"><a class="header-anchor" href="#runtime-behavior"><span>Runtime Behavior</span></a></h2><ol><li>When a user begins a task, the system identifies the administration it belongs to.</li><li>It queries the <code>administration_agreements</code> table for required agreements.</li><li>For each agreement, it checks whether the user has signed that version in <code>user_agreements</code>.</li><li>If not, it presents the agreement content in the user&#39;s preferred locale (fallback to English).</li><li>On acceptance, it inserts a <code>user_agreements</code> record with timestamp and signed locale.</li><li>The user proceeds only after signing all required agreements.</li></ol><h2 id="edge-cases-and-error-handling" tabindex="-1"><a class="header-anchor" href="#edge-cases-and-error-handling"><span>Edge Cases and Error Handling</span></a></h2><table><thead><tr><th>Scenario</th><th>Behavior</th></tr></thead><tbody><tr><td>User has already signed the required version</td><td>Proceed without prompting</td></tr><tr><td>User has signed a different version</td><td>Prompt to sign the required version</td></tr><tr><td>Agreement translation missing for locale</td><td>Fallback to English</td></tr><tr><td>Agreement version missing or inactive</td><td>Block task and log error</td></tr><tr><td>User tries to skip signing</td><td>Block progression and show error</td></tr><tr><td>User signs agreement but fails to store</td><td>Show retry or contact support</td></tr></tbody></table><h2 id="design-rationale" tabindex="-1"><a class="header-anchor" href="#design-rationale"><span>Design Rationale</span></a></h2><ul><li>Versioning allows legal compliance over time as agreement text evolves.</li><li>Multi-language support enables accessibility and equity.</li><li>Decoupling content and logic supports reusable agreement types across multiple administrations.</li><li>Storing agreement content in DB ensures transactional integrity and simplifies backups/version control.</li><li>Single current version per agreement ensures clarity and avoids ambiguity in enforcement.</li></ul><h2 id="sql-schema" tabindex="-1"><a class="header-anchor" href="#sql-schema"><span>SQL Schema</span></a></h2><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> agreements <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  name <span class="token keyword">TEXT</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  agreement_type <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>agreement_type <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">&#39;tos&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;assent&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;consent&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  requires_minor <span class="token keyword">BOOLEAN</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">FALSE</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> agreement_versions <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  agreement_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> agreements<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  is_current <span class="token keyword">BOOLEAN</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">FALSE</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- Enforce only one current version per agreement</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> one_current_version_per_agreement</span>
<span class="line"><span class="token keyword">ON</span> agreement_versions<span class="token punctuation">(</span>agreement_id<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">WHERE</span> is_current<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> agreement_translations <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  agreement_version_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> agreement_versions<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  github_filename <span class="token keyword">TEXT</span><span class="token punctuation">,</span>     <span class="token comment">-- e.g., &quot;agreements/assent/eye_tracking/v2_en.html&quot;</span></span>
<span class="line">  github_commit_sha <span class="token keyword">TEXT</span><span class="token punctuation">,</span>   <span class="token comment">-- e.g., &quot;f9e8d7c6...&quot;</span></span>
<span class="line">  github_repo <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">  created_at <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  locale <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  content <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">UNIQUE</span> <span class="token punctuation">(</span>agreement_version_id<span class="token punctuation">,</span> locale<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> administration_agreements <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  administration_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> administrations<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  agreement_version_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> agreement_versions<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">UNIQUE</span> <span class="token punctuation">(</span>administration_id<span class="token punctuation">,</span> agreement_version_id<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_agreements <span class="token punctuation">(</span></span>
<span class="line">  id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  user_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span><span class="token punctuation">,</span></span>
<span class="line">  agreement_version_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> agreement_versions<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  signed_at <span class="token keyword">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">  signed_locale <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">UNIQUE</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> agreement_version_id<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="api-contract" tabindex="-1"><a class="header-anchor" href="#api-contract"><span>API Contract</span></a></h2><h3 id="get-api-users-user-id-administration-administration-id-agreements-pending" tabindex="-1"><a class="header-anchor" href="#get-api-users-user-id-administration-administration-id-agreements-pending"><span><code>GET /api/users/:user_id/administration/:administration_id/agreements/pending</code></span></a></h3><p>Returns a list of agreement versions the user must sign before proceeding.</p><h3 id="post-api-users-user-id-agreements-agreement-version-id-sign" tabindex="-1"><a class="header-anchor" href="#post-api-users-user-id-agreements-agreement-version-id-sign"><span><code>POST /api/users/:user_id/agreements/:agreement_version_id/sign</code></span></a></h3><p>Marks the agreement version as signed.</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;signed_locale&quot;</span><span class="token operator">:</span> <span class="token string">&quot;en&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="migration-plan" tabindex="-1"><a class="header-anchor" href="#migration-plan"><span>Migration Plan</span></a></h2><ol><li>Deploy new schema with the above tables.</li><li>Migrate existing agreement content from GitHub <code>roar-legal-docs</code> repo to the <code>agreement translations</code> table.</li><li>Write GitHub action to populate new <code>agreements</code>, <code>agreement_versions</code>, and <code>agreement_translations</code> when GitHub legal docs are updated.</li><li>Backfill any existing acceptances (from <code>user</code> document&#39;s <code>legal</code> field) if applicable.</li><li>Update task start logic to check <code>user_agreements</code> before proceeding.</li><li>Build admin UI to assign agreement versions to administrations.</li><li>Build multilingual form rendering component.</li></ol><h2 id="summary" tabindex="-1"><a class="header-anchor" href="#summary"><span>Summary</span></a></h2><p>This spec introduces a robust, versioned, and multilingual agreements framework that integrates with the administration lifecycle. It ensures legal compliance, user clarity, and runtime efficiency.</p>`,18))])}const u=e(p,[["render",r],["__file","agreements.html.vue"]]),m=JSON.parse('{"path":"/developer/tech-specs/backend/agreements.html","title":"ROAR Agreements: Technical Specification","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"Purpose and Scope","slug":"purpose-and-scope","link":"#purpose-and-scope","children":[]},{"level":2,"title":"System Overview","slug":"system-overview","link":"#system-overview","children":[{"level":3,"title":"Definitions","slug":"definitions","link":"#definitions","children":[]},{"level":3,"title":"Component Flow Diagram","slug":"component-flow-diagram","link":"#component-flow-diagram","children":[]}]},{"level":2,"title":"Runtime Behavior","slug":"runtime-behavior","link":"#runtime-behavior","children":[]},{"level":2,"title":"Edge Cases and Error Handling","slug":"edge-cases-and-error-handling","link":"#edge-cases-and-error-handling","children":[]},{"level":2,"title":"Design Rationale","slug":"design-rationale","link":"#design-rationale","children":[]},{"level":2,"title":"SQL Schema","slug":"sql-schema","link":"#sql-schema","children":[]},{"level":2,"title":"API Contract","slug":"api-contract","link":"#api-contract","children":[{"level":3,"title":"GET /api/users/:user_id/administration/:administration_id/agreements/pending","slug":"get-api-users-user-id-administration-administration-id-agreements-pending","link":"#get-api-users-user-id-administration-administration-id-agreements-pending","children":[]},{"level":3,"title":"POST /api/users/:user_id/agreements/:agreement_version_id/sign","slug":"post-api-users-user-id-agreements-agreement-version-id-sign","link":"#post-api-users-user-id-agreements-agreement-version-id-sign","children":[]}]},{"level":2,"title":"Migration Plan","slug":"migration-plan","link":"#migration-plan","children":[]},{"level":2,"title":"Summary","slug":"summary","link":"#summary","children":[]}],"git":{"updatedTime":1751819643000,"contributors":[{"name":"Adam Richie-Halford","username":"Adam Richie-Halford","email":"richiehalford@gmail.com","commits":2,"url":"https://github.com/Adam Richie-Halford"}]},"filePathRelative":"developer/tech-specs/backend/agreements.md"}');export{u as comp,m as data};
